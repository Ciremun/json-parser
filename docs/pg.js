let input = document.getElementById('input');
let output = document.getElementById('output');

let memory = new WebAssembly.Memory({ initial: 4096 });
let HEAP8 = new Int8Array(memory.buffer);
let HEAPU8 = new Uint8Array(memory.buffer);
let HEAP16 = new Int16Array(memory.buffer);
let HEAPU16 = new Uint16Array(memory.buffer);
let HEAP32 = new Uint32Array(memory.buffer);
let HEAPU32 = new Uint32Array(memory.buffer);
let HEAPF32 = new Float32Array(memory.buffer);
let HEAPF64 = new Float64Array(memory.buffer);

let toUtf8Decoder = new TextDecoder("utf-8");

function toUTF8(ptr) {
    let len = 0 | 0; ptr |= 0;
    for (let i = ptr; HEAPU8[i] != 0; i++) len++;
    return toUtf8Decoder.decode(HEAPU8.subarray(ptr, ptr + len));
}

let blob = atob(`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
GwvwAQIEfwN+IAEpAwghByACBEAgASAHQgF8Igc3AwgLIAdCAXwhCCABKAIEIgUgB6ciBmohBEIA
IQcDQCAELQAAIgNBDU1BAEEBIAN0QYHMAHEbIANBIEYgA0EsRnJyIANB3QBGIANB/QBGcnJFBEAg
ASAHIAh8NwMIIARBAWohBCAHQgF8IQcMAQsLIAUgBmohAUIAIQgDQCAHUEUEQCABMAAAQlB8IglC
CloEQCAAQQQ2AgggAEEGNgIADwUgB0J/fCEHIAFBAWohASAJIAhCCn58IQgMAgsACwsgAEEENgIA
IABCACAIfSAIIAIbNwMICwuSAQIAQYAIC4EBJAQAADAEAAA8BAAARgQAAFAEAABcBAAAZwQAAFVO
S05PV04ASlNPTl9PQkpFQ1QASlNPTl9TVFJJTkcASlNPTl9CT09MAEpTT05fTlVMTABKU09OX05V
TUJFUgBKU09OX0FSUkFZAEpTT05fRVJST1IAdHJ1ZQBmYWxzZQBudWxsAEGECQsDkAQBAC8JcHJv
ZHVjZXJzAQxwcm9jZXNzZWQtYnkBBWNsYW5nDzEwLjAuMC00dWJ1bnR1MQ==`);
let array = new Uint8Array(new ArrayBuffer(blob.length));

for (let i = 0; i < blob.length; i++)
    array[i] = blob.charCodeAt(i);

let imports = {
    env: {
        memory: memory,
        print: console.log,
        output_result: (str) => { output.value = toUTF8(str); },
    }
}

WebAssembly.instantiate(array, imports).then(
    function (wa) {
        input.addEventListener('input', () => {
            let encoder = new TextEncoder();
            let bytes = encoder.encode(input.value);
            let ptr = wa.instance.exports.wasm_alloc(BigInt(bytes.byteLength));
            let buffer = new Uint8Array(memory.buffer, ptr, bytes.byteLength + 1);
            buffer.set(bytes);
            wa.instance.exports.parse_json(ptr);
        });
    }
);